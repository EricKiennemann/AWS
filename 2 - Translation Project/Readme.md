# General view

![](.//media/image1.png)

# API Gateway

![](.//media/image2.png)

# Lambda Function

## Python code

import logging

import json

import boto3

import os

import uuid

from contextlib import closing

translate = boto3.client('translate')

polly = boto3.client('polly')

logger = logging.getLogger()

logger.setLevel(logging.INFO)

def lambda\_handler(event, context):

\# prepare parameters for translate call : from fr to en language

\# the text to translate is passed from API Gateway using "event"
variable

logger.info(event)

review\_id = "1"

source\_language = "fr"

target\_language = "en"

review = event\['review'\]

\#calling AWS translate

result = translate.translate\_text(Text=review,
SourceLanguageCode=source\_language,
TargetLanguageCode=target\_language)

logging.info("Translation output: " + str(result))

\# calling AWS polling with passing the "TranslatedText" from AWS
translate

response = polly.synthesize\_speech(OutputFormat='mp3', Text =
result.get('TranslatedText'),TextType='text', VoiceId = "Amy")

\# building the file name with a unique name (from uuid library)

postId = 'sd'+str(uuid.uuid1())

\# write the mp3 file into a temporary folder of lambda function

if "AudioStream" in response:

with closing(response\["AudioStream"\]) as stream:

output = os.path.join("/tmp/", postId)

print(output)

with open(output, "wb") as file:

file.write(stream.read())

\#build the file name with the extension

mp3file = postId + '.mp3'

\# use boto3 library to connect to s3

\# the S3 bucket "translationproject" must me created manually

s3 = boto3.client('s3')

\# copy the mp3 sound file from lambda temporary folder to s3 bucket

s3.upload\_file('/tmp/' + postId, 'translationproject', mp3file)

\# add acl right to this file so that this file can be read from public
internet

s3.put\_object\_acl(ACL='public-read', Bucket='translationproject', Key=
mp3file)

\# return the file name to the API gateway

return {'statusCode': 200,'body': json.dumps(mp3file)}

## Autorisations

Add a role to lambda function

![](.//media/image3.png)

To give rights to access to :

  - Translate

  - Polly

  - S3

{

"Version": "2012-10-17",

"Statement": \[

{

"Effect": "Allow",

"Action": \[

"translate:\*",

"comprehend:DetectDominantLanguage",

"cloudwatch:GetMetricStatistics",

"cloudwatch:ListMetrics",

"polly:\*",

"s3:\*"

\],

"Resource": "\*"

}

\]

}

![](.//media/image4.png)

# S3 Bucket

The S3 Bucket is both used for :

  - Hosting the html file (see below) for the client side

  - Store the mp3 files generated by polly and stored in the S3 bucket
    by the lambda function

![](.//media/image5.png)

# The Html File

\<\!DOCTYPE html\>

\<html\>

\<head\>

\<meta charset="UTF-8"\>

\<title\>Hearing Translation\</title\>

\<\!-- Add some CSS to change client UI --\>

\<style\>

body {

background-color: \#232F3E;

}

label, button {

color: \#FF9900;

font-family: Arial, Helvetica, sans-serif;

font-size: 20px;

margin-left: 40px;

}

input {

color: \#232F3E;

font-family: Arial, Helvetica, sans-serif;

font-size: 20px;

margin-left: 20px;

}

\</style\>

\<script\>

// define the callAPI function that takes a text and call the AWS API
gateway to translate the text in english and transform it to voice

var callAPI = (fText)=\>{

// instantiate a headers object

var myHeaders = new Headers();

// add content type header to object

myHeaders.append("Content-Type", "application/json");

// using built in JSON utility package turn object to string and store
in a variable

var raw = JSON.stringify({"review":fText});

// create a JSON object with parameters for API call and store in a
variable

var requestOptions = {

method: 'POST',

headers: myHeaders,

body: raw,

redirect: 'follow'

};

// make API call with parameters and use promises to get response

fetch("https://xbwspsrcy8.execute-api.us-east-1.amazonaws.com/dev",
requestOptions)

.then(response =\> response.text())

.then(result =\> {

// call soundFile function to read the mp3 file

var soundFile = document.createElement("audio");

soundFile.preload = "auto";

var src = document.createElement("source");

src.src = JSON.parse(result).body.slice(1,JSON.parse(result).body.length
- 1)

soundFile.appendChild(src);

soundFile.load();

soundFile.volume = 0.500000;

soundFile.play();

})

.catch(error =\> console.log('error', error));

}

\</script\>

\</head\>

\<body\>

\<form\>

\<label\>Type your text in french :\</label\>

\<input type="text" id="fText" style = "width: 400px;"\>

\<\!-- set button onClick method to call function we defined passing
input values as parameters --\>

\<button type="button"
onclick="callAPI(document.getElementById('fText').value)"\>Translate\</button\>

\</form\>

\</body\>

\</html\>
